<<<<<<< HEAD
=======
# first pipeline

# azure-pipelines.yml (ejemplo Node.js)
>>>>>>> 7c66cd4 (New entrance)
trigger:
  branches:
    include:
      - main

pr:
  branches:
    include:
<<<<<<< HEAD
      - main
=======
      - '*'         # ejecuta CI para PRs (validación)
>>>>>>> 7c66cd4 (New entrance)

pool:
  vmImage: 'ubuntu-latest'

variables:
  nodeVersion: '18.x'
<<<<<<< HEAD

stages:
- stage: BuildAndScan
  displayName: Build, Test & Scan
  jobs:
  - job: build
    displayName: Build and Scan Code
=======
  webAppName: '$(webAppName)'        # define en Library o pipeline variables
  azureSubscription: 'MiAzureSub'    # nombre del Service Connection

stages:
- stage: Build
  displayName: Build & Test
  jobs:
  - job: build
>>>>>>> 7c66cd4 (New entrance)
    steps:
    - task: NodeTool@0
      inputs:
        versionSpec: '$(nodeVersion)'
      displayName: 'Use Node.js'

<<<<<<< HEAD
    - script: npm i
      displayName: 'Install dependencies'

    - script: |
        echo "Creando package-lock.json..."
        npm install --package-lock-only
      displayName: 'Generate package-lock.json'

    - script: npm install -g @angular/cli
      displayName: 'Install Angular CLI'

    - script: |
        npm test || echo "Tests failed — continuing pipeline"
      displayName: 'Run unit tests (ignore failures)'

    - script: echo "Skipping build — no build script defined"
      displayName: 'Build project (skipped)'

    - task: Checkmarx AST@3
      inputs:
        CheckmarxService: 'juiceshop-connection'
        projectName: '$(Build.Repository.Name)'
        branchName: '$(Build.SourceBranchName)'
        tenantName: 'nfr_lugapel-ast'
        additionalParams: '--async'

#    - script: |
#        echo "=== Iniciando análisis de dependencias con npm audit ==="
#        echo "Instalando dependencias..."
#        npm install
#
#        echo "Ejecutando npm audit con reporte JSON..."
#        npm audit --json > $(Build.SourcesDirectory)/sca-report.json || true
#
#        echo "Analizando severidades detectadas..."
#        HIGH=$(cat $(Build.SourcesDirectory)/sca-report.json | jq '.metadata.vulnerabilities.high')
#        CRITICAL=$(cat $(Build.SourcesDirectory)/sca-report.json | jq '.metadata.vulnerabilities.critical')
#
#        echo "Vulnerabilidades detectadas:"
#        echo "  High: $HIGH"
#        echo "  Critical: $CRITICAL"
#
#        if [ "$HIGH" -gt 0 ] || [ "$CRITICAL" -gt 0 ]; then
#          echo "❌ Se detectaron vulnerabilidades severas. Falla de seguridad."
#          exit 1
#        else
#          echo "✅ No se detectaron vulnerabilidades severas. Continuando..."
#        fi
#      displayName: 'Security Gate - Validar vulnerabilidades con npm audit'


#    - task: PublishPipelineArtifact@1
#      condition: always()
#      inputs:
#        targetPath: '$(Build.SourcesDirectory)/sca-report.json'
#        artifact: 'sca-scan'
#      displayName: 'Publish SCA Report'

# - stage: Deploy
#   displayName: Deploy to Azure (main only)
#   dependsOn: BuildAndScan
#   condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
#   jobs:
#   - deployment: deployWeb
#     environment: 'production'
#     strategy:
#       runOnce:
#         deploy:
#           steps:
#           - download: current
#             artifact: drop
#           - task: AzureWebApp@1
#             inputs:
#               azureSubscription: '$(azureSubscription)'
#               appName: '$(webAppName)'
#               package: '$(Pipeline.Workspace)/drop/**/*.zip'
#             displayName: 'Deploy to Azure Web App'
=======
    - script: npm ci
      displayName: 'npm ci'

    - script: npm test
      displayName: 'Run tests'

    - script: npm run build
      displayName: 'Build'

    - task: PublishBuildArtifacts@1
      inputs:
        PathtoPublish: '$(System.DefaultWorkingDirectory)/dist'
        ArtifactName: 'drop'
      displayName: 'Publish artifact'

- stage: Deploy
  displayName: Deploy to Azure (main only)
  dependsOn: Build
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
  jobs:
  - deployment: deployWeb
    environment: 'production'
    strategy:
      runOnce:
        deploy:
          steps:
          - download: current
            artifact: drop

          - task: AzureWebApp@1
            inputs:
              azureSubscription: '$(azureSubscription)'
              appName: '$(webAppName)'
              package: '$(Pipeline.Workspace)/drop/**/*.zip'
            displayName: 'Deploy to Azure Web App'
>>>>>>> 7c66cd4 (New entrance)
