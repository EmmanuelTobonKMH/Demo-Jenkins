# azure-pipelines.yml - Juice Shop (Node 18, frontend handling, Checkmarx)
trigger:
  branches:
    include:
      - main

pr:
  branches:
    include:
      - '*'         # ejecuta CI para PRs (validación)

pool:
  vmImage: 'ubuntu-latest'

variables:
  nodeVersion: '18.x'    # Node compatible con juice-shop@15

stages:
- stage: BuildAndScan
  displayName: Build, Test & Scan
  jobs:
  - job: build
    displayName: Build and Scan Code
    steps:

    # -------------------------
    - task: NodeTool@0
      inputs:
        versionSpec: '$(nodeVersion)'
      displayName: 'Use Node.js $(nodeVersion)'

    - script: |
        node -v
        npm -v
      displayName: 'Show Node and NPM versions'
    # -------------------------

    # Ensure root package-lock.json exists (so cache can use it)
    - script: |
        if [ ! -f package-lock.json ]; then
          echo "Creando package-lock.json en la raíz..."
          npm install --package-lock-only
        else
          echo "package-lock.json ya existe en la raíz"
        fi
      displayName: 'Ensure root package-lock.json'

    # Cache npm (root) using package-lock.json
    - task: Cache@2
      inputs:
        key: 'npm | "$(Agent.OS)" | package-lock.json'
        path: ~/.npm
      displayName: 'Cache npm (root)'

    # Install root dependencies reproducible
    - script: npm ci
      displayName: 'Install root dependencies (npm ci)'

    # -------------------------
    # Frontend: install deps and run ngcc
    # -------------------------
    - script: |
        if [ -d frontend ]; then
          echo "Instalando dependencias en frontend..."
          cd frontend
          # Si frontend tiene package-lock.json usa npm ci, si no usa install con legacy-peer-deps
          if [ -f package-lock.json ]; then
            npm ci --legacy-peer-deps
          else
            npm install --legacy-peer-deps
            npm install --package-lock-only || true
          fi
        else
          echo "No existe carpeta 'frontend', se omite paso frontend install"
        fi
      displayName: 'Install frontend dependencies'

    - script: |
        if [ -d frontend ]; then
          echo "Ejecutando ngcc en frontend (usando npx)..."
          cd frontend
          # usar npx para asegurar binario local
          npx ngcc --tsconfig "./src/tsconfig.app.json" --first-only || true
        fi
      displayName: 'Run ngcc (Angular compatibility compiler)'

    - script: |
        if [ -d frontend ]; then
          echo "Construyendo frontend (si el proyecto lo requiere)..."
          cd frontend
          npm run build || echo "Frontend build failed — continuing"
        fi
      displayName: 'Build frontend (if needed)'

    # -------------------------
    - script: |
        npm test || echo "Tests failed — continuing pipeline"
      displayName: 'Run unit tests (ignore failures)'

    - script: npm audit --audit-level=moderate || true
      displayName: 'Run npm audit (no-fail)'

    - script: echo "Build step (skipped or handled above)"
      displayName: 'Build project (info)'

    # -------------------------
    # Checkmarx AST task (ajusta service connection y inputs segun tu organización)
    - task: Checkmarx AST@3
      displayName: 'Run Checkmarx AST scan'
      inputs:
        CheckmarxService: 'juiceshop-connection'   # revisa que esta service connection exista en Project settings -> Service connections
        projectName: '$(Build.Repository.Name)'
        branchName: '$(Build.SourceBranchName)'
        tenantName: 'nfr_lugapel-ast'
