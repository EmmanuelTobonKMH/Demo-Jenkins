# azure-pipelines.yml (Node.js - actualizado)
trigger:
  branches:
    include:
      - main

pr:
  branches:
    include:
      - '*'         # ejecuta CI para PRs (validación)

pool:
  vmImage: 'ubuntu-latest'

variables:
  nodeVersion: '22.x'    # <-- actualizado a Node 22

stages:
- stage: BuildAndScan
  displayName: Build, Test & Scan
  jobs:
  - job: build
    displayName: Build and Scan Code
    steps:
    - task: NodeTool@0
      inputs:
        versionSpec: '$(nodeVersion)'
      displayName: 'Use Node.js $(nodeVersion)'

    - script: |
        node -v
        npm -v
      displayName: 'Show Node and NPM versions'

    - task: Cache@2
      inputs:
        key: 'npm | "$(Agent.OS)" | package-lock.json'
        path: ~/.npm
      displayName: 'Cache npm'

    - script: npm ci
      displayName: 'Install dependencies (npm ci)'

    - script: |
        if [ ! -f package-lock.json ]; then
          echo "Creando package-lock.json..."
          npm install --package-lock-only
        else
          echo "package-lock.json ya existe"
        fi
      displayName: 'Ensure package-lock.json'

    - script: npm install -g @angular/cli
      displayName: 'Install Angular CLI'

    - script: |
        npm test || echo "Tests failed — continuing pipeline"
      displayName: 'Run unit tests (ignore failures)'

    - script: npm audit --audit-level=moderate || true
      displayName: 'Run npm audit (no-fail)'

    - script: echo "Skipping build — no build script defined"
      displayName: 'Build project (skipped)'

    - task: Checkmarx AST@3
      inputs:
        CheckmarxService: 'juiceshop-connection'   # revisar que exista y tenga credenciales
        projectName: '$(Build.Repository.Name)'
        branchName: '$(Build.SourceBranchName)'
        tenantName: 'nfr_lugapel-ast'
      displayName: 'Run Checkmarx AST scan'



#- stage: Deploy
#  displayName: Deploy to Azure (main only)
#  dependsOn: Build
#  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
#  jobs:
#  - deployment: deployWeb
#    environment: 'production'
#    strategy:
#      runOnce:
#        deploy:
#          steps:
#          - download: current
#            artifact: drop

#         - task: AzureWebApp@1
#            inputs:
#              azureSubscription: '$(azureSubscription)'
#              appName: '$(webAppName)'
#              package: '$(Pipeline.Workspace)/drop/**/*.zip'
#            displayName: 'Deploy to Azure Web App'
